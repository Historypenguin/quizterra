<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Quizterra | Stats</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    body {
      margin: 0;
      font-family: Poppins, sans-serif;
      display: flex;
      height: 100vh;
      background: linear-gradient(120deg, #47a7ff, #745cff, #ff4ef2);
      background-size: 400% 400%;
      animation: gradientMove 11s ease infinite;
      color: white;
    }

    @keyframes gradientMove {
      0% { background-position: 0% 50%; }
      50% { background-position: 100% 50%; }
      100% { background-position: 0% 50%; }
    }

    .sidebar {
      width: 260px;
      background: #002b6f;
      padding: 25px;
      height: 100vh;
      box-shadow: 2px 0 10px rgba(0,0,0,0.4);
    }

    .sidebar h2 { font-size: 40px; margin-bottom: 35px; color: #0fa6ff; font-weight: 900; letter-spacing: 1px; }
    .sidebar a { display: flex; align-items: center; gap: 14px; text-decoration: none; color: white; font-size: 22px; font-weight: 700; padding: 12px 15px; border-radius: 12px; margin-bottom: 18px; transition: 0.25s; cursor: pointer; }
    .sidebar a i { font-size: 24px; }
    .sidebar a:hover { background: rgba(255,255,255,0.15); }
    .sidebar a.active { background: rgba(255,255,255,0.2); }

    .main { flex: 1; padding: 50px; overflow-y: auto; }

    .user-info { display: flex; align-items: center; gap: 20px; margin-bottom: 20px; }
    .user-info img { width: 80px; height: 80px; border-radius: 50%; border: 2px solid white; }
    .user-info h2 { font-size: 28px; font-weight: 700; }

    #claimBtn { background: linear-gradient(135deg, #6a5acd, #00bfff); color: white; font-weight: 700; font-size: 18px; padding: 15px 25px; border: none; border-radius: 15px; cursor: pointer; margin-bottom: 30px; transition: all 0.3s ease; }
    #claimBtn:hover:not(:disabled) { transform: scale(1.05); box-shadow: 0 0 15px rgba(0,0,0,0.3); }
    #claimBtn:disabled { opacity: 0.5; cursor: not-allowed; }

    .stats-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 25px; margin-bottom: 30px; }
    .card { background: rgba(255,255,255,0.2); backdrop-filter: blur(10px); padding: 22px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.3); text-align: center; transition: transform 0.3s, box-shadow 0.3s; }
    .card:hover { transform: translateY(-5px); box-shadow: 0 15px 30px rgba(0,0,0,0.4); }
    .card h3 { font-size: 24px; margin-bottom: 10px; font-weight: 700; }
    .stat { font-size: 36px; font-weight: 700; }

    .progress-container { margin-bottom: 30px; }
    .progress-label { font-weight: 600; margin-bottom: 5px; }
    .progress-bar-bg { width: 100%; height: 25px; background: rgba(255,255,255,0.2); border-radius: 15px; overflow: hidden; }
    .progress-bar-fill { height: 100%; width: 0%; background: #0fa6ff; border-radius: 15px; transition: width 0.5s ease; text-align: right; padding-right: 10px; line-height: 25px; font-weight: 700; }

    .weekly-streak { display: flex; gap: 10px; margin-bottom: 30px; }
    .week { width: 40px; height: 40px; background: rgba(255,255,255,0.2); border-radius: 8px; display: flex; align-items: center; justify-content: center; font-weight: 700; }
    .week.completed { background: #0fa6ff; }

    @media(max-width: 1000px) { .stats-grid { grid-template-columns: repeat(2, 1fr); } }
    @media(max-width: 650px) { .stats-grid { grid-template-columns: 1fr; } }
  </style>
</head>

<body>
  <div class="sidebar">
    <h2>QUIZTERRA</h2>
    <a href="stats.html" class="active"><i class="fas fa-chart-line"></i> Stats</a>
    <a href="market.html"><i class="fas fa-store"></i> Market</a>
    <a href="inventory.html"><i class="fas fa-box"></i> Inventory</a>
    <a href="sets.html"><i class="fas fa-layer-group"></i> Sets</a>
    <a id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a>
  </div>

  <div class="main">
    <div class="user-info">
      <img id="profilePic" src="" alt="Profile Picture">
      <h2 id="username">USERNAME</h2>
    </div>

    <button id="claimBtn">Claim 1000 Tokens</button>

    <!-- Level Progress -->
    <div class="progress-container">
      <div class="progress-label">Level Progress</div>
      <div class="progress-bar-bg">
        <div class="progress-bar-fill" id="levelProgress">0%</div>
      </div>
    </div>

    <!-- Weekly Study Streak -->
    <div class="weekly-streak" id="weeklyStreak"></div>

    <div class="stats-grid">
      <div class="card"><h3>Level</h3><div class="stat" id="level">0</div></div>
      <div class="card"><h3>XP</h3><div class="stat" id="xp">0</div></div>
      <div class="card"><h3>Coins</h3><div class="stat" id="coins">0</div></div>
      <div class="card"><h3>Games Played</h3><div class="stat" id="gamesPlayed">0</div></div>
      <div class="card"><h3>Correct Answers</h3><div class="stat" id="correct">0</div></div>
      <div class="card"><h3>Wrong Answers</h3><div class="stat" id="wrong">0</div></div>
    </div>
  </div>

<script>
window.onload = () => {
  let user = JSON.parse(localStorage.getItem("quizterraUser"));
  if(!user) { window.location.href="login.html"; return; }

  document.getElementById("username").innerText = user.username || "UNKNOWN";
  document.getElementById("profilePic").src = user.picture || "";

  if(!user.stats) {
    user.stats = { level:0, xp:0, coins:0, gamesPlayed:0, correct:0, wrong:0, lastClaim:null, studyWeeks:0, lastLevelMilestone:0 };
    localStorage.setItem("quizterraUser", JSON.stringify(user));
  }

  const stats = user.stats;

  const stats = user.stats;

// FIX: Update study weeks so level progress actually moves
stats.studyWeeks++;
localStorage.setItem("quizterraUser", JSON.stringify(user));


  // Count up animation
  function countUp(element, end) {
    let start=0, step=Math.ceil(end/30);
    const interval=setInterval(()=>{
      start+=step;
      if(start>=end){ element.innerText=end; clearInterval(interval); }
      else element.innerText=start;
    },20);
  }

  countUp(document.getElementById("level"), stats.level);
  countUp(document.getElementById("xp"), stats.xp);
  countUp(document.getElementById("coins"), stats.coins);
  countUp(document.getElementById("gamesPlayed"), stats.gamesPlayed);
  countUp(document.getElementById("correct"), stats.correct);
  countUp(document.getElementById("wrong"), stats.wrong);

  // Daily Claim
  const claimBtn = document.getElementById("claimBtn");
  function updateClaimButton() {
    if(stats.lastClaim){
      const elapsed = Date.now()-stats.lastClaim;
      if(elapsed<24*60*60*1000){
        claimBtn.disabled=true;
        const remaining = 24*60*60*1000-elapsed;
        const h=Math.floor(remaining/3600000);
        const m=Math.floor((remaining%3600000)/60000);
        const s=Math.floor((remaining%60000)/1000);
        claimBtn.innerText=`Claim in ${h}h ${m}m ${s}s`;
        setTimeout(updateClaimButton,1000);
        return;
      }
    }
    claimBtn.disabled=false; claimBtn.innerText="Claim 1000 Tokens";
  }
  updateClaimButton();
  claimBtn.onclick=()=>{
    const now=Date.now();
    if(!stats.lastClaim || (now-stats.lastClaim)>=24*60*60*1000){
      stats.coins+=1000;
      stats.lastClaim=now;
      localStorage.setItem("quizterraUser", JSON.stringify(user));
      document.getElementById("coins").innerText=stats.coins;
      updateClaimButton();
      alert("You claimed 1000 tokens!");
    }
  };

  // Level Progress Bar
  const levelProgress = document.getElementById("levelProgress");
  function updateLevelProgress() {
    let progressPercent = Math.min(100, (stats.studyWeeks % 10) * 10);
    levelProgress.style.width = progressPercent + "%";
    levelProgress.innerText = progressPercent + "%";
  }
  updateLevelProgress();

  // Weekly Streak
  const weeklyStreak = document.getElementById("weeklyStreak");
  weeklyStreak.innerHTML="";
  for(let i=1;i<=10;i++){
    const weekDiv=document.createElement("div");
    weekDiv.className="week";
    if(i<=stats.studyWeeks%10) weekDiv.classList.add("completed");
    weekDiv.innerText=i;
    weeklyStreak.appendChild(weekDiv);
  }

  // Level Up check & XP increase only once per milestone
  function checkLevelUp() {
    const currentMilestone = Math.floor(stats.studyWeeks / 10);
    if(currentMilestone > stats.lastLevelMilestone){
      stats.level = currentMilestone + 1;
      countUp(document.getElementById("level"), stats.level);

      if(stats.level >= 10){
        stats.xp += 1;
        countUp(document.getElementById("xp"), stats.xp);
      }

      stats.lastLevelMilestone = currentMilestone;
      localStorage.setItem("quizterraUser", JSON.stringify(user));
      updateLevelProgress();
    }
  }
  checkLevelUp();

  // Logout
  document.getElementById("logoutBtn").onclick=()=>{
    localStorage.removeItem("quizterraUser");
    window.location="login.html";
  };
};
</script>
</body>
</html>
