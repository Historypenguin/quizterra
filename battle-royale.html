<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Quizterra | Battle Royale</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
<style>
body {
  font-family: Poppins, sans-serif;
  margin: 0;
  min-height: 100vh;
  background: linear-gradient(135deg, #6a11cb, #2575fc);
  color: white;
  display: flex;
  flex-direction: column;
  padding: 20px;
  box-sizing: border-box;
}

.quiz-container {
  display: flex;
  gap: 30px;
  max-width: 1000px;
  width: 100%;
  margin: auto;
  background: rgba(0,0,0,0.3);
  border-radius: 20px;
  padding: 20px;
  flex-wrap: wrap;
  position: relative;
}

.top-icons {
  position: absolute;
  top: 15px;
  right: 15px;
  display: flex;
  gap: 15px;
}

.icon-btn {
  background: rgba(255,255,255,0.2);
  border: none;
  color: white;
  font-size: 20px;
  padding: 8px;
  border-radius: 50%;
  cursor: pointer;
  transition: 0.3s;
}
.icon-btn:hover { background: rgba(255,255,255,0.4); }

.left-panel, .right-panel {
  display: flex;
  flex-direction: column;
  gap: 30px;
}

.left-panel {
  flex: 1;
  align-items: center;
}

.right-panel {
  flex: 2;
}

.player-box, .enemy-box {
  display: flex;
  flex-direction: column;
  align-items: center;
}

.hp-bar-bg {
  width: 150px;
  height: 15px;
  background: rgba(255,255,255,0.3);
  border-radius: 10px;
  margin-top: 5px;
  overflow: hidden;
}

.hp-bar-fill {
  height: 100%;
  width: 100%;
  background: #0fa6ff;
  text-align: right;
  line-height: 15px;
  font-weight: bold;
  padding-right: 5px;
  transition: width 0.5s;
}

.question-box {
  background: rgba(255,255,255,0.1);
  padding: 20px;
  border-radius: 15px;
  font-size: 20px;
  font-weight: 600;
  min-height: 120px;
}

.question-box img {
  max-width: 100%;
  border-radius: 15px;
  margin-top: 15px;
}

.options-grid {
  display: grid;
  grid-template-columns: repeat(2, 1fr);
  gap: 15px;
}

.option-btn {
  padding: 20px;
  border-radius: 15px;
  font-weight: 700;
  font-size: 18px;
  cursor: pointer;
  border: none;
  color: white;
  transition: transform 0.2s, opacity 0.2s;
}
.option-btn:hover { transform: scale(1.03); opacity: 0.9; }

.red { background: #e74c3c; }
.orange { background: #f39c12; }
.green { background: #27ae60; }
.blue { background: #2980b9; }

.option-correct { border: 3px solid #28a745 !important; }
.option-wrong { border: 3px solid #dc3545 !important; }

#battle-log {
  background: rgba(0,0,0,0.4);
  padding: 15px;
  border-radius: 15px;
  max-height: 200px;
  overflow-y: auto;
  font-size: 16px;
  margin-top: 20px;
  width: 100%;
}

#player-img, #enemy-img {
  width: 120px;
  height: 120px;
  border-radius: 12px;
  border: 2px solid white;
}

#typingBox {
  display: none;
  margin-top: 15px;
}

#typingInput {
  padding: 12px;
  width: 100%;
  border-radius: 12px;
  border: none;
  font-size: 18px;
}

#typingSubmit {
  margin-top: 10px;
  width: 100%;
  padding: 14px;
  border-radius: 15px;
  background: #0fa6ff;
  color: white;
  font-size: 18px;
  border: none;
  cursor: pointer;
  font-weight: bold;
}
#typingSubmit:hover { opacity: 0.9; }
</style>
</head>
<body>

<div class="quiz-container">

  <div class="top-icons">
    <button class="icon-btn" id="endBtn" title="End Battle">ðŸš©</button>
  </div>

  <!-- PANELS -->
  <div class="left-panel">
    <div class="player-box">
      <img id="player-img" src="https://i.postimg.cc/2yWnW6sY/wizard.png">
      <div id="player-name">You</div>
      <div class="hp-bar-bg"><div class="hp-bar-fill" id="player-hp">100</div></div>
    </div>

    <div class="enemy-box">
      <img id="enemy-img">
      <div id="enemy-name"></div>
      <div class="hp-bar-bg"><div class="hp-bar-fill" id="enemy-hp">0</div></div>
    </div>
  </div>

  <div class="right-panel">
    <h2 id="setTitle">Loading Battle...</h2>

    <div class="question-box" id="questionBox"></div>

    <!-- Multiple choice grid -->
    <div class="options-grid" id="mcGrid">
      <button class="option-btn red" id="btnRed"></button>
      <button class="option-btn orange" id="btnOrange"></button>
      <button class="option-btn green" id="btnGreen"></button>
      <button class="option-btn blue" id="btnBlue"></button>
    </div>

    <!-- Typing answer UI -->
    <div id="typingBox">
      <input id="typingInput" placeholder="Type your answer...">
      <button id="typingSubmit">Submit</button>
    </div>
  </div>

  <div style="width:100%;">
    <div id="battle-log"></div>
  </div>
</div>

<script>
let user = JSON.parse(localStorage.getItem("quizterraUser"));
if(!user) location.href="login.html";

// Load selected set from Game Modes page
const set = JSON.parse(localStorage.getItem("currentSet"));
if(!set) { alert("No set loaded!"); location.href="select.html"; }

document.getElementById("setTitle").textContent = set.name;

const playerQuestions = set.questions;

const enemyRounds = [
  {name:"Iced Blue Donut", hp:50, attack:8, image:"https://i.postimg.cc/GpCtt1Yq/Iced-Blue-Donut.webp"},
  {name:"Stary Bot", hp:60, attack:10, image:"https://i.postimg.cc/dt9ZKTVs/staryBot.png"},
  {name:"Chef", hp:70, attack:9, image:"https://i.postimg.cc/gnxq22bw/chef.png"},
  {name:"Cat Milk", hp:80, attack:7, image:"https://cdn.glitch.global/36ec2602-304b-444b-8f2f-08c65c92bbc0/thumbnails%2FcatMilk.png?1750455696008"},
  {name:"Spooky Bot Ghost", hp:100, attack:15, image:"https://i.postimg.cc/63SV6Tc6/Spooky-Mega-Ghost-1.gif"},
  {name:"Blooket Warrior", hp:150, attack:20, image:"https://i.postimg.cc/htNhD5Z3/Blooket-Warrior.gif"}
];

let currentRound = 0;
let enemy = {...enemyRounds[currentRound]};
let playerHp = 100;
let questionData = null;

const mcGrid = document.getElementById("mcGrid");
const typingBox = document.getElementById("typingBox");
const typingInput = document.getElementById("typingInput");
const typingSubmit = document.getElementById("typingSubmit");
const questionBox = document.getElementById("questionBox");

function log(msg){
  battleLog.innerHTML += msg + "<br>";
  battleLog.scrollTop = battleLog.scrollHeight;
}

document.getElementById("endBtn").onclick = () => {
  if(confirm("End battle?")) location.href="stats.html";
};

function loadEnemy(){
  enemy = {...enemyRounds[currentRound]};
  document.getElementById("enemy-img").src = enemy.image;
  document.getElementById("enemy-name").innerText = enemy.name;

  document.getElementById("enemy-hp").style.width = enemy.hp + "px";
  document.getElementById("enemy-hp").innerText = enemy.hp;

  log(`âš”ï¸ ${enemy.name} appears!`);
  showQuestion();
}

function showQuestion() {
  questionData = playerQuestions[Math.floor(Math.random() * playerQuestions.length)];

  questionBox.innerHTML = questionData.question;
  if(questionData.image){
    const img = document.createElement("img");
    img.src = questionData.image;
    questionBox.appendChild(img);
  }

  // Typing Question
  if(questionData.type === "typing"){
    mcGrid.style.display = "none";
    typingBox.style.display = "block";

    typingInput.value = "";
    typingSubmit.onclick = () => checkAnswer(typingInput.value.trim(), questionData.correct);
  }
  else {
    mcGrid.style.display = "grid";
    typingBox.style.display = "none";

    const colors = ["Red","Orange","Green","Blue"];
    const btns = {
      Red: btnRed,
      Orange: btnOrange,
      Green: btnGreen,
      Blue: btnBlue
    };

    colors.forEach((c,i)=>{
      const btn = btns[c];
      btn.textContent = questionData.options[i] || "";
      btn.classList.remove("option-correct","option-wrong");
      btn.onclick = () => checkAnswer(btn.textContent, questionData.correct);
    });
  }
}

function checkAnswer(selected, correct){
  let isCorrect = false;

  if(questionData.type === "typing"){
    isCorrect = selected.toLowerCase() === correct.toLowerCase();
  } else {
    isCorrect = selected === correct;
  }

  handleDamage(isCorrect);
}

function handleDamage(correct) {
  if(correct){
    enemy.hp -= 20;
    if(enemy.hp < 0) enemy.hp = 0;

    log(`âœ… Correct! You dealt 20 damage.`);
  } else {
    playerHp -= 15;
    if(playerHp < 0) playerHp = 0;

    log(`âŒ Wrong! You lost 15 HP.`);
  }

  updateBars();

  if(enemy.hp <= 0){
    winRound();
    return;
  }

  if(playerHp <= 0){
    log("ðŸ’€ You were defeated!");
    disableButtons();
    return;
  }

  // Enemy attack
  playerHp -= enemy.attack;
  if(playerHp < 0) playerHp = 0;

  log(`${enemy.name} attacks for ${enemy.attack} damage!`);

  updateBars();

  if(playerHp <= 0){
    log("ðŸ’€ You were defeated!");
    disableButtons();
    return;
  }

  setTimeout(showQuestion, 800);
}

function updateBars(){
  document.getElementById("enemy-hp").style.width = enemy.hp + "px";
  document.getElementById("enemy-hp").innerText = enemy.hp;

  document.getElementById("player-hp").style.width = playerHp + "px";
  document.getElementById("player-hp").innerText = playerHp;
}

function disableButtons(){
  btnRed.disabled = true;
  btnOrange.disabled = true;
  btnGreen.disabled = true;
  btnBlue.disabled = true;
  typingSubmit.disabled = true;
}

function winRound(){
  log(`ðŸ† ${enemy.name} defeated!`);
  currentRound++;

  if(currentRound >= enemyRounds.length){
    log("ðŸŽ‰ YOU WIN THE GAME!");
    disableButtons();
    return;
  }

  playerHp += 20;
  if(playerHp > 100) playerHp = 100;

  updateBars();
  setTimeout(loadEnemy, 1200);
}

loadEnemy();
</script>

</body>
</html>
