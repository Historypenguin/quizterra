<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Quizterra | Question Editor</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">

  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

  <style>
    :root{
      --sidebar-width:260px;
      --accent-1: #00d0ff;
      --accent-2: #ff4ef2;
      --bg-dark: rgba(255,255,255,0.08);
      --glass: rgba(255,255,255,0.12);
      --glass-2: rgba(255,255,255,0.08);
      --text: #ffffff;
      --muted: rgba(255,255,255,0.75);
    }

    * { box-sizing: border-box; }
    html,body { height:100%; margin:0; font-family:Poppins, sans-serif; color:var(--text); }

    body {
      display:flex;
      background: linear-gradient(120deg, #47a7ff, #745cff, #ff4ef2);
      background-size: 400% 400%;
      animation: gradientMove 11s ease infinite;
      min-height:100vh;
      overflow:auto;
    }
    @keyframes gradientMove {
      0%{background-position:0% 50%}50%{background-position:100% 50%}100%{background-position:0% 50%}
    }

    /* Sidebar (unchanged look) */
    .sidebar{
      width: var(--sidebar-width);
      background:#002b6f;
      padding:25px;
      height:100vh;
      box-shadow:2px 0 10px rgba(0,0,0,0.4);
      position:fixed;
      left:0; top:0;
    }
    .sidebar h2{ font-size:40px; margin-bottom:35px; color:#0fa6ff; font-weight:900; letter-spacing:1px }
    .sidebar a{ display:flex; align-items:center; gap:14px; text-decoration:none; color:white; font-size:22px; font-weight:700; padding:12px 15px; border-radius:12px; margin-bottom:18px; transition:.25s; cursor:pointer }
    .sidebar a i{ font-size:24px }
    .sidebar a:hover{ background: rgba(255,255,255,0.15) }
    .sidebar a.active{ background: rgba(255,255,255,0.2) }

    /* Main content */
    .main {
      margin-left: var(--sidebar-width);
      padding: 40px;
      width: calc(100% - var(--sidebar-width));
    }

    .top-row {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:20px;
      margin-bottom:18px;
    }

    .user-info { display:flex; align-items:center; gap:20px; }
    .user-info img{ width:64px; height:64px; border-radius:50%; border:2px solid rgba(255,255,255,0.12); object-fit:cover }
    .user-info h2{ font-size:20px; margin:0; font-weight:700 }

    /* Editor Card */
    .editor {
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      border-radius: 18px;
      padding: 28px;
      box-shadow: 0 12px 36px rgba(0,0,0,0.35), 0 0 40px rgba(0,0,0,0.08) inset;
      backdrop-filter: blur(8px) saturate(120%);
      border: 1px solid rgba(255,255,255,0.06);
      max-width: 1100px;
      margin: 0 auto;
    }

    .editor-header {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 16px;
      margin-bottom: 18px;
    }

    .editor-header .title {
      font-size: 22px;
      font-weight: 800;
      letter-spacing: .6px;
      display:flex;
      gap:12px;
      align-items:center;
    }

    .editor-header .title small {
      display:inline-block;
      font-size:13px;
      font-weight:600;
      color:var(--muted);
      margin-left:8px;
    }

    .controls {
      display:flex;
      gap:10px;
      align-items:center;
    }

    .btn {
      background: linear-gradient(135deg, var(--accent-1), var(--accent-2));
      color:white;
      border:none;
      border-radius:12px;
      padding:10px 14px;
      font-weight:700;
      cursor:pointer;
      box-shadow: 0 6px 18px rgba(0,0,0,0.25);
    }

    .btn.ghost {
      background: transparent;
      border: 1px solid rgba(255,255,255,0.08);
      color: var(--text);
      padding:8px 12px;
    }

    /* Question area */
    .question-area {
      margin-top:10px;
      display:grid;
      grid-template-columns: 1fr 360px;
      gap:20px;
      align-items:start;
    }

    /* Left column: question & answers */
    .left {
      display:flex;
      flex-direction:column;
      gap:18px;
    }

    .input-large {
      background: var(--glass);
      border-radius:12px;
      padding:16px;
      border: 1px solid rgba(255,255,255,0.04);
      color:var(--text);
      font-size:18px;
      min-height:88px;
      outline:none;
      resize:vertical;
    }

    .row {
      display:flex;
      gap:12px;
      align-items:center;
      flex-wrap:wrap;
    }

    /* Answer cards */
    .answers {
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }

    .answer-card {
      background: linear-gradient(180deg, rgba(255,255,255,0.025), rgba(255,255,255,0.02));
      border-radius:12px;
      padding:12px;
      display:flex;
      gap:10px;
      align-items:center;
      box-shadow: 0 8px 24px rgba(0,0,0,0.25);
      transition: transform .14s ease;
    }

    .answer-card:hover { transform: translateY(-6px) }

    .answer-card input[type="text"] {
      background:transparent;
      border:none;
      color:var(--text);
      font-weight:700;
      font-size:16px;
      width:100%;
      outline:none;
    }

    .answer-radio {
      display:flex;
      align-items:center;
      gap:8px;
      font-weight:700;
      color:var(--muted);
    }

    /* Right column: image & settings */
    .right {
      display:flex;
      flex-direction:column;
      gap:14px;
    }

    .image-uploader {
      background: var(--glass-2);
      border-radius:12px;
      padding:12px;
      text-align:center;
      min-height:200px;
      border:1px dashed rgba(255,255,255,0.06);
      display:flex;
      flex-direction:column;
      justify-content:center;
      gap:12px;
    }

    .image-uploader img.preview {
      max-width:100%;
      max-height:180px;
      border-radius:10px;
      border:1px solid rgba(255,255,255,0.06);
      object-fit:contain;
    }

    .small {
      font-size:13px; color:var(--muted);
    }

    .settings-card {
      background: rgba(255,255,255,0.02);
      border-radius:12px;
      padding:12px;
      display:flex;
      flex-direction:column;
      gap:8px;
      border:1px solid rgba(255,255,255,0.03);
    }

    .settings-row {
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
    }

    select, input[type="number"] {
      background: transparent;
      color: var(--text);
      border: 1px solid rgba(255,255,255,0.06);
      padding:8px 10px;
      border-radius:8px;
      font-weight:700;
    }

    .bottom-actions {
      display:flex;
      justify-content:space-between;
      align-items:center;
      margin-top:18px;
      gap:12px;
    }

    .muted-note { color:var(--muted); font-size:13px }

    /* Responsive */
    @media(max-width:1100px){
      .question-area{ grid-template-columns:1fr 300px }
      .right { order:2 }
    }
    @media(max-width:880px){
      .question-area{ grid-template-columns: 1fr; }
      .right { order:2; }
    }
  </style>
</head>
<body>
  <!-- SIDEBAR -->
  <div class="sidebar">
    <h2>QUIZTERRA</h2>
    <a href="stats.html"><i class="fas fa-chart-line"></i> Stats</a>
    <a href="market.html"><i class="fas fa-store"></i> Market</a>
    <a href="inventory.html"><i class="fas fa-box"></i> Inventory</a>
    <a href="sets.html"><i class="fas fa-layer-group"></i> Sets</a>
    <a id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a>
  </div>

  <!-- MAIN -->
  <div class="main">
    <div class="top-row">
      <div class="user-info">
        <img id="profilePic" src="" alt="Profile">
        <div>
          <h2 id="username">USERNAME</h2>
          <div class="small muted-note" id="setNameDisplay">Loading set…</div>
        </div>
      </div>

      <div class="controls">
        <button class="btn ghost" id="backBtn"><i class="fas fa-arrow-left"></i> Back</button>
        <button class="btn" id="saveBtn"><i class="fas fa-save"></i> Save Question</button>
      </div>
    </div>

    <div class="editor" id="editorCard">
      <div class="editor-header">
        <div class="title">
          Question Editor
          <small id="editorHint">Create or edit a question</small>
        </div>

        <div class="small muted-note" id="lastSaved">Not saved yet</div>
      </div>

      <div class="question-area">
        <!-- LEFT: Question + Answers -->
        <div class="left">
          <label class="small">Question</label>
          <textarea id="questionText" class="input-large" placeholder="Type your question here..."></textarea>

          <div class="row">
            <div style="flex:1">
              <label class="small">Answers</label>
              <div class="answers" id="answersContainer">
                <!-- answer cards injected here -->
              </div>
            </div>

            <div style="width:220px">
              <label class="small">Options</label>
              <div class="settings-card">
                <div class="settings-row">
                  <div style="font-weight:700">Point Value</div>
                  <select id="pointValue">
                    <option value="100">100</option>
                    <option value="200">200</option>
                    <option value="300">300</option>
                    <option value="400">400</option>
                    <option value="500">500</option>
                  </select>
                </div>

                <div class="settings-row">
                  <div style="font-weight:700">Time Limit</div>
                  <select id="timeLimit">
                    <option value="10">10s</option>
                    <option value="15">15s</option>
                    <option value="20">20s</option>
                    <option value="30">30s</option>
                    <option value="60">60s</option>
                  </select>
                </div>

                <div class="settings-row" style="justify-content:flex-start; gap:10px;">
                  <input type="checkbox" id="shuffleAnswers" />
                  <label for="shuffleAnswers" style="font-weight:700; cursor:pointer">Shuffle answers</label>
                </div>
              </div>
            </div>
          </div>

          <div class="bottom-actions">
            <div>
              <button class="btn ghost" id="addImageBtn"><i class="fas fa-image"></i> Add / Replace Image</button>
              <input type="file" id="imageInput" accept="image/*" style="display:none" />
            </div>

            <div style="display:flex; gap:8px;">
              <button class="btn ghost" id="clearBtn"><i class="fas fa-eraser"></i> Clear</button>
              <button class="btn ghost" id="duplicateBtn"><i class="fas fa-copy"></i> Duplicate</button>
            </div>
          </div>
        </div>

        <!-- RIGHT: Image + small preview + meta -->
        <div class="right">
          <div class="image-uploader" id="imageUploader">
            <div class="small" id="imageHint">No image added</div>
            <img class="preview" id="imagePreview" src="" alt="" style="display:none" />
            <div style="display:flex; gap:8px; justify-content:center;">
              <button class="btn ghost" id="removeImageBtn" style="display:none"><i class="fas fa-trash"></i> Remove Image</button>
            </div>
          </div>

          <div class="settings-card">
            <div style="font-weight:700">Question Metadata</div>
            <div class="small">Correct Answer: <span id="correctPreview">—</span></div>
            <div class="small">Points: <span id="pointsPreview">100</span></div>
            <div class="small">Time: <span id="timePreview">10s</span></div>
            <div style="height:6px"></div>
            <div class="muted-note">Changes auto-save. Click Save to finalize and return.</div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // Helper: read query params
    function qParam(name) {
      const url = new URL(window.location.href);
      return url.searchParams.get(name);
    }

    // Debounce helper
    function debounce(fn, wait = 700) {
      let t;
      return (...args) => {
        clearTimeout(t);
        t = setTimeout(() => fn(...args), wait);
      };
    }

    // Default structure of a question
    function emptyQuestion() {
      return {
        question: "",
        image: null,           // dataURL or null
        answers: ["", "", "", ""],
        correctIndex: 0,
        points: 100,
        timeLimit: 10,
        shuffle: false,
        lastEdited: Date.now()
      };
    }

    // State
    let user = null;
    let setIndex = parseInt(qParam('set'), 10);
    let qIndex = qParam('q') !== null ? parseInt(qParam('q'), 10) : null;
    let selectedSet = null;
    let currentQuestion = null;
    let isNewQuestion = (qIndex === null);

    // Elements
    const usernameEl = document.getElementById('username');
    const profilePic = document.getElementById('profilePic');
    const setNameDisplay = document.getElementById('setNameDisplay');

    const questionText = document.getElementById('questionText');
    const answersContainer = document.getElementById('answersContainer');
    const imageInput = document.getElementById('imageInput');
    const imagePreview = document.getElementById('imagePreview');
    const imageHint = document.getElementById('imageHint');
    const removeImageBtn = document.getElementById('removeImageBtn');

    const pointValue = document.getElementById('pointValue');
    const timeLimit = document.getElementById('timeLimit');
    const shuffleAnswers = document.getElementById('shuffleAnswers');

    const lastSaved = document.getElementById('lastSaved');
    const correctPreview = document.getElementById('correctPreview');
    const pointsPreview = document.getElementById('pointsPreview');
    const timePreview = document.getElementById('timePreview');

    const saveBtn = document.getElementById('saveBtn');
    const backBtn = document.getElementById('backBtn');
    const addImageBtn = document.getElementById('addImageBtn');
    const clearBtn = document.getElementById('clearBtn');
    const duplicateBtn = document.getElementById('duplicateBtn');

    // Initialize app
    function init() {
      user = JSON.parse(localStorage.getItem('quizterraUser'));
      if (!user) { window.location.href = 'login.html'; return; }

      usernameEl.innerText = user.username || 'USERNAME';
      profilePic.src = user.picture || '';

      if (!Number.isFinite(setIndex) || !user.sets || !user.sets[setIndex]) {
        alert('Set not found. Returning to Sets.');
        window.location.href = 'sets.html';
        return;
      }

      selectedSet = user.sets[setIndex];
      setNameDisplay.innerText = selectedSet.name || 'Unnamed Set';

      // Load question (if editing)
      if (qIndex !== null) {
        if (!selectedSet.cards || !selectedSet.cards[qIndex]) {
          alert('Question not found. Returning to Sets.');
          window.location.href = 'sets.html';
          return;
        }
        currentQuestion = JSON.parse(JSON.stringify(selectedSet.cards[qIndex])); // copy
        isNewQuestion = false;
      } else {
        currentQuestion = emptyQuestion();
        isNewQuestion = true;
      }

      // Ensure cards array exists
      if (!selectedSet.cards) selectedSet.cards = [];

      renderAll();
      attachEvents();
    }

    // Render answers
    function renderAnswers() {
      answersContainer.innerHTML = '';
      currentQuestion.answers.forEach((ans, i) => {
        const wrap = document.createElement('div');
        wrap.className = 'answer-card';
        wrap.innerHTML = `
          <div class="answer-radio">
            <input name="correct" type="radio" value="${i}" ${currentQuestion.correctIndex === i ? 'checked':''} />
          </div>
          <input type="text" class="answer-input" data-index="${i}" placeholder="Answer ${i+1}" value="${escapeHtml(ans)}" />
        `;
        answersContainer.appendChild(wrap);
      });

      // attach local listeners
      answersContainer.querySelectorAll('.answer-input').forEach(inp => {
        inp.addEventListener('input', handleAnswerChange);
      });
      answersContainer.querySelectorAll('input[name="correct"]').forEach(r => {
        r.addEventListener('change', handleCorrectChange);
      });

      updateCorrectPreview();
    }

    // Render entire page
    function renderAll() {
      questionText.value = currentQuestion.question || '';
      pointValue.value = currentQuestion.points || 100;
      timeLimit.value = currentQuestion.timeLimit || 10;
      shuffleAnswers.checked = !!currentQuestion.shuffle;
      renderAnswers();
      renderImage();
      updateMetaPreviews();
      touchLastSaved(false);
    }

    function renderImage() {
      if (currentQuestion.image) {
        imagePreview.src = currentQuestion.image;
        imagePreview.style.display = 'block';
        imageHint.style.display = 'none';
        removeImageBtn.style.display = 'inline-block';
      } else {
        imagePreview.src = '';
        imagePreview.style.display = 'none';
        imageHint.style.display = 'block';
        removeImageBtn.style.display = 'none';
      }
    }

    // Event handlers
    function handleQuestionChange() {
      currentQuestion.question = questionText.value;
      markEdited();
    }

    function handleAnswerChange(e) {
      const idx = parseInt(e.target.dataset.index, 10);
      currentQuestion.answers[idx] = e.target.value;
      markEdited();
    }

    function handleCorrectChange(e) {
      currentQuestion.correctIndex = parseInt(e.target.value, 10);
      updateCorrectPreview();
      markEdited();
    }

    function handlePointsChange() {
      currentQuestion.points = parseInt(pointValue.value, 10);
      pointsPreview.innerText = currentQuestion.points;
      markEdited();
    }

    function handleTimeChange() {
      currentQuestion.timeLimit = parseInt(timeLimit.value, 10);
      timePreview.innerText = currentQuestion.timeLimit + 's';
      markEdited();
    }

    function handleShuffleChange() {
      currentQuestion.shuffle = shuffleAnswers.checked;
      markEdited();
    }

    // File -> dataURL
    function handleImageSelect(file) {
      const reader = new FileReader();
      reader.onload = () => {
        currentQuestion.image = reader.result;
        renderImage();
        markEdited();
      };
      reader.readAsDataURL(file);
    }

    // Save question into selectedSet.cards
    function saveQuestion(finalize=false) {
      currentQuestion.lastEdited = Date.now();
      // Validation: ensure at least one answer non-empty
      // (We still allow saving empty for now)
      if (isNewQuestion) {
        // push a deep copy
        selectedSet.cards.push(JSON.parse(JSON.stringify(currentQuestion)));
        isNewQuestion = false;
        qIndex = selectedSet.cards.length - 1;
      } else {
        selectedSet.cards[qIndex] = JSON.parse(JSON.stringify(currentQuestion));
      }

      // persist
      user.sets[setIndex] = selectedSet;
      localStorage.setItem('quizterraUser', JSON.stringify(user));
      touchLastSaved(true);

      if (finalize) {
        // redirect to sets
        window.location.href = 'sets.html';
      }
    }

    // Delete image
    function removeImage() {
      if (!currentQuestion.image) return;
      if (!confirm('Remove the image?')) return;
      currentQuestion.image = null;
      renderImage();
      markEdited();
    }

    // Clear question (resets fields)
    function clearQuestion() {
      if (!confirm('Clear this question fields?')) return;
      currentQuestion = emptyQuestion();
      renderAll();
      markEdited();
    }

    // Duplicate question (push copy to set)
    function duplicateQuestion() {
      const copy = JSON.parse(JSON.stringify(currentQuestion));
      copy.question += ' (copy)';
      selectedSet.cards.push(copy);
      user.sets[setIndex] = selectedSet;
      localStorage.setItem('quizterraUser', JSON.stringify(user));
      alert('Question duplicated into this set.');
    }

    // Auto-save debounce
    const autoSave = debounce(() => {
      // Auto-save edits to the live slot (not finalizing/redirect)
      saveQuestion(false);
    }, 900);

    function markEdited() {
      currentQuestion.lastEdited = Date.now();
      touchLastSaved(false);
      autoSave();
    }

    function touchLastSaved(isSaved) {
      if (isSaved) {
        lastSaved.innerText = 'Saved • ' + (new Date()).toLocaleTimeString();
      } else {
        lastSaved.innerText = 'Editing...';
      }
    }

    function updateMetaPreviews() {
      correctPreview.innerText = currentQuestion.answers[currentQuestion.correctIndex] || `Answer ${currentQuestion.correctIndex+1}`;
      pointsPreview.innerText = currentQuestion.points;
      timePreview.innerText = currentQuestion.timeLimit + 's';
    }

    function updateCorrectPreview() {
      correctPreview.innerText = currentQuestion.answers[currentQuestion.correctIndex] || `Answer ${currentQuestion.correctIndex+1}`;
    }

    // Attach DOM events
    function attachEvents() {
      questionText.addEventListener('input', handleQuestionChange);
      pointValue.addEventListener('change', handlePointsChange);
      timeLimit.addEventListener('change', handleTimeChange);
      shuffleAnswers.addEventListener('change', handleShuffleChange);

      addImageBtn.addEventListener('click', () => imageInput.click());
      imageInput.addEventListener('change', (e) => {
        if (e.target.files && e.target.files[0]) {
          const f = e.target.files[0];
          if (!f.type.startsWith('image/')) { alert('Please choose an image file.'); return; }
          handleImageSelect(f);
        }
      });

      removeImageBtn.addEventListener('click', removeImage);

      saveBtn.addEventListener('click', () => {
        saveQuestion(true);
      });

      backBtn.addEventListener('click', () => {
        // If isNew and some content present, offer to save
        if (isNewQuestion && (currentQuestion.question || currentQuestion.answers.some(a=>a))) {
          if (confirm('You have unsaved content. Save this question before leaving?')) {
            saveQuestion(true);
            return;
          }
        }
        window.location.href = 'sets.html';
      });

      clearBtn.addEventListener('click', clearQuestion);
      duplicateBtn.addEventListener('click', duplicateQuestion);

      // Logout
      document.getElementById('logoutBtn').addEventListener('click', () => {
        localStorage.removeItem('quizterraUser');
        window.location.href = 'login.html';
      });

      // keyboard: ctrl+s to save
      window.addEventListener('keydown', (e) => {
        if ((e.ctrlKey || e.metaKey) && e.key === 's') {
          e.preventDefault();
          saveQuestion(true);
        }
      });
    }

    // Safe escape for value injection
    function escapeHtml(str) {
      if (str === null || str === undefined) return '';
      return String(str).replace(/&/g, '&amp;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    // Initialize answers DOM (4)
    function ensureFourAnswers() {
      while (currentQuestion.answers.length < 4) currentQuestion.answers.push('');
      if (currentQuestion.answers.length > 4) currentQuestion.answers = currentQuestion.answers.slice(0,4);
    }

    // On load
    (function(){
      try {
        init();
        ensureFourAnswers();
      } catch (err) {
        console.error(err);
        alert('An error occurred. Returning to sets.');
        window.location.href = 'sets.html';
      }
    })();

  </script>
</body>
</html>
